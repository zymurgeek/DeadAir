<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<HTML xmlns="http://www.w3.org/1999/xhtml">
  <HEAD>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Dead Air</title>
  </HEAD>
  <BODY>
    <!-- https://developers.google.com/youtube/iframe_api_reference -->
    <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <div id="player"></div>
    <div id="playlistinfo"></div>
    <H1>Start by creating a playlist</H1>
    <OL>
    <LI>Create a playlist with YouTube Creator Studio (it's under your
      account link).  Select Video Manager, then Playlists.</LI>
    <LI>Make the playlist public or unlisted.</LI>
    <LI>Share the playlist with everyone who wants to add songs by
      sending them the link from the Collaborate tab. Make sure
      "Collaborators can add videos" is enabled.</LI>
    <LI>Enter the playlist ID above. The ID is in the
      "Invite Collaborators" link after <CODE>list=</CODE>
      and before <CODE>&amp;jct=</CODE>.</LI>
    </OL>
    <H1>To queue songs</H1>
    <OL>
    <LI>Each participant must add the play list to their account by browsing
      to the playlist and selecting "+ Save" on the play list.</LI>
    <LI>To queue a video, go to its page, click the button with three lines and
      a "+" (next to "share"), and check the box next to the playlist.</LI>
    </OL>
    <P>After the first song is queued, press "Start playlist".
    <P>If you don't queue a video before the play list ends, you'll have
    <strong>dead air</strong> and have to reload the playlist.
    <script>
      var playlistId = localStorage.getItem('playlistId');
      var INITIAL_LOAD = 'INITIAL_LOAD';
      var PLAYING = 'PLAYING';
      var RELOADING_PLAYLIST = 'RELOADING_PLAYLIST';
      var lastPlaylist = null;
      var indexOfNextVideo = 0;
      var indexOfLastVideoPlayed = 0;

      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      var playlistUrl = 'https://www.youtube.com/playlist?list='
        + playlistId;
       var playlistInfo = '<P>'
        + '<FORM>'
        + 'YouTube Playlist ID: '
        + '<INPUT TYPE="text" NAME="playlistid" VALUE="'
        + playlistId + '"> '
        + '<INPUT TYPE="button" NAME="button" Value="Start playlist" '
        + 'onClick="processForm(this.form)" >'
        + '</FORM>'
      var playlistInfoDiv = document.getElementById('playlistinfo');
      playlistInfoDiv.insertAdjacentHTML( 'beforeend', playlistInfo);

      function processForm(form) {
        setState(INITIAL_LOAD)
        lastPlaylist = null;
        indexOfNextVideo = 0
        playlistId = form.playlistid.value;
        localStorage.setItem('playlistId', playlistId);
        loadPlaylist()
      }

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      var player;

      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '390',
          width: '640',
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      // 4. The API will call this function when the video player is ready.
      function onPlayerReady(event) {
        console.log('Player ready');
        setState(INITIAL_LOAD);
        loadPlaylist();
      }

      // 5. The API calls this function when the player's state changes.
      //    The function indicates that when playing a video (state=1),
      //    the player should play for six seconds and then stop.
      function onPlayerStateChange(event) {
        console.log('onPlayerStateChange event:', getPlayerStateName());
        switch (event.data) {
          case YT.PlayerState.CUED:
            switch (state) {
              case INITIAL_LOAD:
                play();
                break;
              case RELOADING_PLAYLIST:
                if (indexOfNextVideo < player.getPlaylist().length) {
                  play();
                }
                break;
            }
            break;

          case YT.PlayerState.PLAYING:
            indexOfLastVideoPlayed = player.getPlaylistIndex();
            showQueue();
            break;

          case YT.PlayerState.ENDED:
            console.log('index of last video played:', indexOfLastVideoPlayed,
              'Playlist index:', player.getPlaylistIndex());
            if (player.getPlaylistIndex() == indexOfLastVideoPlayed) {
              reloadPlaylist();
            }
            break;
        }
      }

      function setState(newState) {
        state = newState;
        console.log('state:', state);
      }

      function getPlayerStateName() {
        if (player.getPlayerState() == -1) {
          return 'UNSTARTED';
        }
        if (player.getPlayerState() == 0) {
          return 'ENDED';
        }
        if (player.getPlayerState() == 1) {
          return 'PLAYING';
        }
        if (player.getPlayerState() == 2) {
          return 'PAUSED';
        }
        if (player.getPlayerState() == 3) {
          return 'BUFFERING';
        }
        if (player.getPlayerState() == 5) {
          return 'CUED';
        }
      }

      function showQueue() {
        console.log('Playing index', player.getPlaylistIndex(),
          'from queue: ', player.getPlaylist());
      }

      function play() {
        setState(PLAYING);
        player.playVideoAt(indexOfNextVideo);
      }

      function reloadPlaylist() {
        setState(RELOADING_PLAYLIST);
        lastPlaylist = player.getPlaylist();
        loadPlaylist();
      }

      function loadPlaylist() {
        if (lastPlaylist) {
          indexOfNextVideo = lastPlaylist.length;
          console.log('indexOfNextVideo:', indexOfNextVideo);
        }
        console.log('cueing playlist');
        player.cuePlaylist({
          listType: 'playlist',
          list: playlistId,
          index: indexOfNextVideo});
      }
    </script>
  </BODY>
</HTML>
